#include <jni.h>
#include <android/log.h>
#include <android/asset_manager.h>
#include <android/asset_manager_jni.h>
#include <string>
#include <vector>
#include <memory>
#include <GLES2/gl2.h>
#include <EGL/egl.h>
#include <ctime>
#include <cstdlib>

// Ê®°Êãü Vuforia 10 API
#define VU_SUCCESS 0
#define VU_FAILURE -1

// Ê®°Êãü Vuforia 10 ÁªìÊûÑ‰Ωì
typedef struct {
    float data[2];
} VuVec2F;

typedef struct {
    int data[2];
} VuVec2I;

typedef struct {
    VuVec2I pos;
    VuVec2I size;
} VuViewport;

typedef struct {
    VuVec2I resolution;
} VuRenderViewConfig;

typedef struct {
    void* vbMesh;
    VuViewport vbViewport;
} VuRenderState;

typedef struct {
    float data[16];
} VuMatrix44F;

typedef struct {
    VuMatrix44F pose;
    int poseStatus;
} VuPoseInfo;

typedef struct {
    char name[64];
} VuImageTargetObservationTargetInfo;

// ÂâçÂêëÂ£∞Êòé
void renderVideoBackground(const VuRenderState& renderState);
void renderSimpleBackground();

// Ê®°Êãü Vuforia 10 Á±ª
class VuRenderController {
public:
    int setRenderViewConfig(const VuRenderViewConfig* config) { 
        if (config) {
            return VU_SUCCESS; 
        }
        return VU_FAILURE;
    }
};

class VuState {
public:
    int getRenderState(VuRenderState* renderState) {
        if (renderState) {
            renderState->vbMesh = nullptr;
            renderState->vbViewport.pos.data[0] = 0;
            renderState->vbViewport.pos.data[1] = 0;
            renderState->vbViewport.size.data[0] = 1280;
            renderState->vbViewport.size.data[1] = 720;
            return VU_SUCCESS;
        }
        return VU_FAILURE;
    }
    
    void release() { 
        delete this; 
    }
};

class VuEngine {
public:
    static VuEngine* create() { 
        return new VuEngine(); 
    }
    
    void destroy() { 
        delete this; 
    }
    
    int start() { 
        return VU_SUCCESS; 
    }
    
    int stop() { 
        return VU_SUCCESS; 
    }
    
    int acquireLatestState(VuState** state) {
        if (state) {
            *state = new VuState(); 
            return VU_SUCCESS;
        }
        return VU_FAILURE;
    }
    
    VuRenderController* getRenderController() { 
        return &renderController; 
    }
    
private:
    VuRenderController renderController;
};

// ÈªòËÆ§ÈÖçÁΩÆÂáΩÊï∞
VuRenderViewConfig vuRenderViewConfigDefault() {
    VuRenderViewConfig config;
    config.resolution.data[0] = 1280;
    config.resolution.data[1] = 720;
    return config;
}

#define LOG_TAG "VuforiaWrapper"
#define LOGI(...) __android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)
#define LOGE(...) __android_log_print(ANDROID_LOG_ERROR, LOG_TAG, __VA_ARGS__)
#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)

// ÂÖ®Â±ÄÂèòÈáè
static VuEngine* gEngine = nullptr;
static VuRenderController* gRenderController = nullptr;
static AAssetManager* gAssetManager = nullptr;
static bool gVuforiaInitialized = false;
static bool gModelLoaded = false;
static bool gARRendering = false;
static bool gTargetDetectionActive = false;
static bool gCameraStarted = false;
static std::vector<std::string> gTargets;
static JavaVM* gJVM = nullptr;
static jobject gTargetCallback = nullptr;

// ÁÆÄÂåñÁöÑÁõÆÊ†áÊ£ÄÊµãÂÆûÁé∞
class SimpleTargetDetector {
private:
    bool mIsActive;
    time_t mLastDetectionTime;
    int mDetectionCounter;
    
public:
    SimpleTargetDetector() : mIsActive(false), mLastDetectionTime(0), mDetectionCounter(0) {}
    
    bool startDetection() {
        LOGI("Starting simple target detection");
        mIsActive = true;
        mDetectionCounter = 0;
        mLastDetectionTime = time(nullptr);
        return true;
    }
    
    void stopDetection() {
        LOGI("Stopping simple target detection");
        mIsActive = false;
    }
    
    bool updateDetection() {
        if (!mIsActive) return false;
        
        // Ê®°ÊãüÁõÆÊ†áÊ£ÄÊµã - ÊØè5ÁßíÊ£ÄÊµã‰∏ÄÊ¨°ÁõÆÊ†á
        time_t currentTime = time(nullptr);
        if (currentTime - mLastDetectionTime >= 5) {
            mLastDetectionTime = currentTime;
            mDetectionCounter++;
            
            // Ê®°ÊãüÊ£ÄÊµãÂà∞ÁõÆÊ†á
            if (mDetectionCounter % 2 == 1) {
                LOGI("üéØ Target found: stones");
                notifyTargetFound("stones");
                return true;
            } else {
                LOGI("‚ùå Target lost: stones");
                notifyTargetLost("stones");
                return false;
            }
        }
        
        return false;
    }
    
private:
    void notifyTargetFound(const std::string& targetName) {
        if (gJVM != nullptr && gTargetCallback != nullptr) {
            JNIEnv* env = nullptr;
            if (gJVM->AttachCurrentThread(&env, nullptr) == JNI_OK && env != nullptr) {
                jclass callbackClass = env->GetObjectClass(gTargetCallback);
                if (callbackClass) {
                    jmethodID methodId = env->GetMethodID(callbackClass, "onTargetFound", "(Ljava/lang/String;)V");
                    if (methodId) {
                        jstring jTargetName = env->NewStringUTF(targetName.c_str());
                        if (jTargetName) {
                            env->CallVoidMethod(gTargetCallback, methodId, jTargetName);
                            env->DeleteLocalRef(jTargetName);
                        }
                    }
                    env->DeleteLocalRef(callbackClass);
                }
            }
        }
    }
    
    void notifyTargetLost(const std::string& targetName) {
        if (gJVM != nullptr && gTargetCallback != nullptr) {
            JNIEnv* env = nullptr;
            if (gJVM->AttachCurrentThread(&env, nullptr) == JNI_OK && env != nullptr) {
                jclass callbackClass = env->GetObjectClass(gTargetCallback);
                if (callbackClass) {
                    jmethodID methodId = env->GetMethodID(callbackClass, "onTargetLost", "(Ljava/lang/String;)V");
                    if (methodId) {
                        jstring jTargetName = env->NewStringUTF(targetName.c_str());
                        if (jTargetName) {
                            env->CallVoidMethod(gTargetCallback, methodId, jTargetName);
                            env->DeleteLocalRef(jTargetName);
                        }
                    }
                    env->DeleteLocalRef(callbackClass);
                }
            }
        }
    }
};

static std::unique_ptr<SimpleTargetDetector> gTargetDetector;

// ===== JNI ÊñπÊ≥ïÂÆûÁé∞ =====

extern "C" JNIEXPORT void JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_setAssetManager(
    JNIEnv* env, jobject thiz, jobject asset_manager) {
    
    if (asset_manager) {
        gAssetManager = AAssetManager_fromJava(env, asset_manager);
        LOGI("Asset manager set successfully");
    } else {
        LOGE("Asset manager is null");
    }
}

extern "C" JNIEXPORT void JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_setLicenseKey(
    JNIEnv* env, jobject thiz, jstring license_key) {
    
    if (license_key) {
        const char* key = env->GetStringUTFChars(license_key, nullptr);
        if (key) {
            LOGI("License key set: %.20s...", key); // Âè™ÊòæÁ§∫Ââç20‰∏™Â≠óÁ¨¶
            env->ReleaseStringUTFChars(license_key, key);
        }
    } else {
        LOGE("License key is null");
    }
}

extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_initVuforia(
    JNIEnv* env, jobject thiz) {
    LOGI("Initializing Vuforia...");
    gVuforiaInitialized = true;
    LOGI("Vuforia initialized successfully");
    return JNI_TRUE;
}

extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_initializeVuforiaNative(
    JNIEnv* env, jobject instance) {
    
    LOGI("Initializing Vuforia 10 engine...");
    
    try {
        // 1. ÂàõÂª∫ÂºïÊìé
        gEngine = VuEngine::create();
        if (gEngine == nullptr) {
            LOGE("Failed to create Vuforia engine");
            return JNI_FALSE;
        }
        
        // 2. Ëé∑ÂèñÊ∏≤ÊüìÊéßÂà∂Âô®
        gRenderController = gEngine->getRenderController();
        if (gRenderController == nullptr) {
            LOGE("Failed to get render controller");
            return JNI_FALSE;
        }
        
        // 3. ËÆæÁΩÆÊ∏≤ÊüìÈÖçÁΩÆ
        VuRenderViewConfig renderConfig = vuRenderViewConfigDefault();
        renderConfig.resolution.data[0] = 1280;
        renderConfig.resolution.data[1] = 720;
        
        int result = gRenderController->setRenderViewConfig(&renderConfig);
        if (result != VU_SUCCESS) {
            LOGE("Failed to set render config: %d", result);
            return JNI_FALSE;
        }
        
        gVuforiaInitialized = true;
        LOGI("Vuforia 10 engine created successfully");
        return JNI_TRUE;
        
    } catch (const std::exception& e) {
        LOGE("Exception during Vuforia initialization: %s", e.what());
        return JNI_FALSE;
    } catch (...) {
        LOGE("Unknown exception during Vuforia initialization");
        return JNI_FALSE;
    }
}

extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_startCameraNative(
    JNIEnv* env, jobject instance, jobject surface) {
    
    if (gEngine == nullptr) {
        LOGE("Engine not created");
        return JNI_FALSE;
    }
    
    LOGI("Starting Vuforia camera...");
    
    try {
        // ÂêØÂä®ÂºïÊìéÔºàËøô‰ºöËá™Âä®ÂêØÂä®Áõ∏Êú∫Ôºâ
        int result = gEngine->start();
        if (result != VU_SUCCESS) {
            LOGE("Failed to start engine: %d", result);
            return JNI_FALSE;
        }
        
        gCameraStarted = true;
        LOGI("Camera started successfully");
        return JNI_TRUE;
        
    } catch (const std::exception& e) {
        LOGE("Exception during camera start: %s", e.what());
        return JNI_FALSE;
    } catch (...) {
        LOGE("Unknown exception during camera start");
        return JNI_FALSE;
    }
}

extern "C" JNIEXPORT void JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_renderFrameNative(
    JNIEnv* env, jobject instance) {
    
    if (gEngine == nullptr) return;
    
    try {
        // Ëé∑ÂèñÊúÄÊñ∞Áä∂ÊÄÅ
        VuState* state = nullptr;
        int result = gEngine->acquireLatestState(&state);
        if (result != VU_SUCCESS || state == nullptr) return;
        
        // Ëé∑ÂèñÊ∏≤ÊüìÁä∂ÊÄÅ
        VuRenderState renderState;
        result = state->getRenderState(&renderState);
        if (result == VU_SUCCESS) {
            // Ê∏≤ÊüìËßÜÈ¢ëËÉåÊôØÔºàËøôÊòØÊòæÁ§∫Áõ∏Êú∫È¢ÑËßàÁöÑÂÖ≥ÈîÆÔºâ
            renderVideoBackground(renderState);
        }
        
        // ÈáäÊîæÁä∂ÊÄÅ
        state->release();
        
    } catch (const std::exception& e) {
        LOGE("Exception during frame rendering: %s", e.what());
    } catch (...) {
        LOGE("Unknown exception during frame rendering");
    }
}

// Ê∏≤ÊüìËßÜÈ¢ëËÉåÊôØÔºàÁõ∏Êú∫È¢ÑËßàÁöÑÊ†∏ÂøÉÔºâ
void renderVideoBackground(const VuRenderState& renderState) {
    try {
        // ËÆæÁΩÆËßÜÂè£
        glViewport(renderState.vbViewport.pos.data[0], 
                   renderState.vbViewport.pos.data[1],
                   renderState.vbViewport.size.data[0], 
                   renderState.vbViewport.size.data[1]);
        
        // Ê∏ÖÈô§ËÉåÊôØ
        glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
        glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
        
        // Ê∏≤ÊüìÁÆÄÂçïÁöÑËÉåÊôØÔºàÊ®°ÊãüÁõ∏Êú∫È¢ÑËßàÔºâ
        renderSimpleBackground();
        
    } catch (...) {
        LOGE("Exception in renderVideoBackground");
    }
}

void renderSimpleBackground() {
    try {
        // Ê∏≤ÊüìÁÆÄÂçïÁöÑËÉåÊôØÈ¢úËâ≤ÔºàÊ®°ÊãüÁõ∏Êú∫È¢ÑËßàÔºâ
        glClearColor(0.2f, 0.3f, 0.8f, 1.0f);
        glClear(GL_COLOR_BUFFER_BIT);
        
        // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†‰∏Ä‰∫õÁÆÄÂçïÁöÑÂõæÂΩ¢Êù•Ê®°ÊãüÁõ∏Êú∫ÂÜÖÂÆπ
        
    } catch (...) {
        LOGE("Exception in renderSimpleBackground");
    }
}

// ÁõÆÊ†áÊï∞ÊçÆÂ∫ìÂíåÊ£ÄÊµãÁõ∏ÂÖ≥ÊñπÊ≥ï
extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_initTargetDatabase(
    JNIEnv* env, jobject thiz) {
    
    LOGI("Initializing target database...");
    
    // Ê£ÄÊü• Asset Manager
    if (gAssetManager == nullptr) {
        LOGE("Asset manager not set");
        return JNI_FALSE;
    }
    
    // ÂàùÂßãÂåñÁõÆÊ†áÂàóË°®
    gTargets.clear();
    gTargets.push_back("stones");
    gTargets.push_back("chips");
    gTargets.push_back("tarmac");
    
    // ÂàõÂª∫ÁõÆÊ†áÊ£ÄÊµãÂô®
    gTargetDetector = std::make_unique<SimpleTargetDetector>();
    
    LOGI("Target database initialized successfully with %zu targets", gTargets.size());
    return JNI_TRUE;
}

extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_startImageTracking(
    JNIEnv* env, jobject thiz) {
    
    LOGI("Starting image tracking...");
    if (gTargetDetector == nullptr) {
        LOGE("Target detector not initialized");
        return JNI_FALSE;
    }
    
    gTargetDetectionActive = gTargetDetector->startDetection();
    LOGI("Image tracking started: %s", gTargetDetectionActive ? "true" : "false");
    return gTargetDetectionActive ? JNI_TRUE : JNI_FALSE;
}

extern "C" JNIEXPORT void JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_stopImageTracking(
    JNIEnv* env, jobject thiz) {
    
    LOGI("Stopping image tracking...");
    if (gTargetDetector != nullptr) {
        gTargetDetector->stopDetection();
    }
    gTargetDetectionActive = false;
}

extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_updateTargetDetection(
    JNIEnv* env, jobject thiz) {
    
    if (gTargetDetector != nullptr && gTargetDetectionActive) {
        return gTargetDetector->updateDetection() ? JNI_TRUE : JNI_FALSE;
    }
    return JNI_FALSE;
}

extern "C" JNIEXPORT void JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_setTargetDetectionCallback(
    JNIEnv* env, jobject thiz, jobject callback) {
    
    if (env && callback) {
        env->GetJavaVM(&gJVM);
        if (gTargetCallback != nullptr) {
            env->DeleteGlobalRef(gTargetCallback);
        }
        gTargetCallback = env->NewGlobalRef(callback);
        LOGI("Target detection callback set");
    }
}

// Ê®°ÂûãÂíåÊ∏≤ÊüìÁõ∏ÂÖ≥ÊñπÊ≥ï
extern "C" JNIEXPORT void JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_setModelLoaded(
    JNIEnv* env, jobject thiz, jboolean loaded) {
    gModelLoaded = loaded;
    LOGI("Model loaded status set to: %s", loaded ? "true" : "false");
}

extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_isModelLoadedNative(
    JNIEnv* env, jobject thiz) {
    return gModelLoaded ? JNI_TRUE : JNI_FALSE;
}

extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_loadGLBModel(
    JNIEnv* env, jobject thiz, jstring model_path) {
    
    if (model_path) {
        const char* path = env->GetStringUTFChars(model_path, nullptr);
        if (path) {
            LOGI("Loading GLB model: %s", path);
            env->ReleaseStringUTFChars(model_path, path);
            
            // Ê®°ÊãüÊ®°ÂûãÂä†ËΩΩÊàêÂäü
            gModelLoaded = true;
            return JNI_TRUE;
        }
    }
    
    LOGE("Invalid model path");
    return JNI_FALSE;
}

extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_startRendering(
    JNIEnv* env, jobject thiz) {
    LOGI("Starting AR rendering");
    gARRendering = true;
    return JNI_TRUE;
}

// Device Tracking Áõ∏ÂÖ≥ÊñπÊ≥ï
extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_enableDeviceTracking(
    JNIEnv* env, jobject thiz) {
    LOGI("Device tracking enabled");
    return JNI_TRUE;
}

extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_disableImageTracking(
    JNIEnv* env, jobject thiz) {
    LOGI("Image tracking disabled");
    return JNI_TRUE;
}

extern "C" JNIEXPORT void JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_setWorldCenterMode(
    JNIEnv* env, jobject thiz) {
    LOGI("World center mode set");
}

extern "C" JNIEXPORT jboolean JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_setupCameraBackground(
    JNIEnv* env, jobject thiz) {
    LOGI("Camera background setup completed");
    return JNI_TRUE;
}

// Ê∏ÖÁêÜËµÑÊ∫ê
extern "C" JNIEXPORT void JNICALL
Java_com_example_ibm_1ai_1weather_1art_1android_VuforiaManager_cleanup(
    JNIEnv* env, jobject thiz) {
    
    LOGI("Cleaning up Vuforia resources");
    
    try {
        // ÂÅúÊ≠¢ÁõÆÊ†áÊ£ÄÊµã
        if (gTargetDetector) {
            gTargetDetector->stopDetection();
            gTargetDetector.reset();
        }
        
        // Ê∏ÖÁêÜÂºïÊìé
        if (gEngine != nullptr) {
            gEngine->stop();
            gEngine->destroy();
            gEngine = nullptr;
        }
        
        // Ê∏ÖÁêÜÂõûË∞É
        if (gTargetCallback != nullptr && env != nullptr) {
            env->DeleteGlobalRef(gTargetCallback);
            gTargetCallback = nullptr;
        }
        
        // ÈáçÁΩÆÁä∂ÊÄÅ
        gRenderController = nullptr;
        gVuforiaInitialized = false;
        gModelLoaded = false;
        gARRendering = false;
        gTargetDetectionActive = false;
        gCameraStarted = false;
        gTargets.clear();
        
        LOGI("Cleanup completed successfully");
        
    } catch (const std::exception& e) {
        LOGE("Exception during cleanup: %s", e.what());
    } catch (...) {
        LOGE("Unknown exception during cleanup");
    }
}